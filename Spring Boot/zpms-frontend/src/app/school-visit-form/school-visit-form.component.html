<!-- school-visit-form.component.html -->
<div class="container py-4">
  <div class="row justify-content-center mb-4">
    <div class="col-xl-10 col-lg-12">
      <form [formGroup]="visitForm" (ngSubmit)="onSubmit()">
        <div class="card shadow-lg">
          <div class="card-body p-3 p-md-4">
            <h4 class="card-title text-center mb-4">शाळा भेट माहिती फॉर्म</h4>

            <!-- School Name -->
            <div class="row g-3 mb-4">
              <div class="col-12">
                <label for="schoolName" class="form-label">शाळेचे नाव</label>
                <input type="text" id="schoolName" class="form-control" formControlName="schoolName">
                <div *ngIf="f['schoolName'].invalid && (f['schoolName'].dirty || f['schoolName'].touched)"
                  class="text-danger small mt-1">
                  <span *ngIf="f['schoolName'].errors?.['required']">शाळेचे नाव आवश्यक आहे.</span>
                  <span *ngIf="f['schoolName'].errors?.['minlength']">किमान ३ अक्षरे आवश्यक.</span>
                </div>
              </div>
            </div>

            <!-- Teacher Information Section -->
            <h5 class="form-section-title mb-3">अ. शिक्षक माहिती (Teacher Information)</h5>
            <div class="row g-3 mb-4">
              <div class="col-md-4 col-sm-6">
                <label for="approvedTeachers" class="form-label">मंजूर शिक्षक</label>
                <input type="number" id="approvedTeachers" class="form-control" formControlName="approvedTeachers">
              </div>
              <div class="col-md-4 col-sm-6">
                <label for="workingTeachers" class="form-label">कार्यरत शिक्षक</label>
                <input type="number" id="workingTeachers" class="form-control" formControlName="workingTeachers">
              </div>
              <div class="col-md-4 col-sm-6">
                <label for="vacantTeachers" class="form-label">रिक्त पदे</label>
                <input type="number" id="vacantTeachers" class="form-control" formControlName="vacantTeachers" readonly>
              </div>
              <div class="col-md-4 col-sm-6">
                <label for="femaleCount" class="form-label">महिला शिक्षक</label>
                <input type="number" id="femaleCount" class="form-control" formControlName="femaleCount">
              </div>
              <div class="col-md-4 col-sm-6">
                <label for="maleCount" class="form-label">पुरुष शिक्षक</label>
                <input type="number" id="maleCount" class="form-control" formControlName="maleCount">
              </div>
              <div class="col-md-4 col-sm-6">
                <label for="presentteachers" class="form-label">आज उपस्थित शिक्षक</label>
                <input type="number" id="presentteachers" class="form-control" formControlName="presentteachers">
              </div>
            </div>

            <!-- Class Visit & Student Attendance Section -->
            <h5 class="form-section-title mb-3">ब. वर्गभेट व विद्यार्थी उपस्थिती (Class Visit & Student Attendance)</h5>
            <div class="row g-3 mb-2">
              <div class="col-md-4">
                <label for="visitedClass" class="form-label">भेट दिलेला वर्ग</label>
                <input type="text" id="visitedClass" class="form-control" formControlName="visitedClass" placeholder="उदा. इयत्ता ५ वी अ">
              </div>
              <div class="col-md-4">
                <label for="grade" class="form-label">इयत्ता (Grade)</label>
                <input type="text" id="grade" class="form-control" formControlName="grade" placeholder="उदा. ५ वी">
              </div>
              <div class="col-md-4">
                <label for="section" class="form-label">तुकडी (Section)</label>
                <input type="text" id="section" class="form-control" formControlName="section" placeholder="उदा. अ">
              </div>
            </div>
            <div class="row g-3 mb-2">
              <div class="col-md-3 col-6">
                <label for="boysCount" class="form-label">पट मुले</label>
                <input type="number" id="boysCount" class="form-control" formControlName="boysCount">
              </div>
              <div class="col-md-3 col-6">
                <label for="girlsCount" class="form-label">पट मुली</label>
                <input type="number" id="girlsCount" class="form-control" formControlName="girlsCount">
              </div>
              <div class="col-md-3 col-sm-6">
                <label for="totalCount" class="form-label">एकूण पट</label>
                <input type="number" id="totalCount" class="form-control" formControlName="totalCount" readonly>
              </div>
              <div class="col-md-3 col-sm-6">
                <label for="attendancePercentage" class="form-label">पट टक्केवारी (%)</label>
                <input type="number" id="attendancePercentage" class="form-control" formControlName="attendancePercentage" readonly>
                 <small class="text-muted">(एकूण पटाच्या तुलनेत)</small>
              </div>
            </div>
            <div class="row g-3 mb-4">
              <div class="col-md-3 col-6">
                <label for="boysPresent" class="form-label">उपस्थित मुले</label>
                <input type="number" id="boysPresent" class="form-control" formControlName="boysPresent">
                 <div *ngIf="f['boysPresent'].errors?.['max']" class="text-danger small mt-1">पटापेक्षा जास्त.</div>
              </div>
              <div class="col-md-3 col-6">
                <label for="girlsPresent" class="form-label">उपस्थित मुली</label>
                <input type="number" id="girlsPresent" class="form-control" formControlName="girlsPresent">
                <div *ngIf="f['girlsPresent'].errors?.['max']" class="text-danger small mt-1">पटापेक्षा जास्त.</div>
              </div>
              <div class="col-md-3 col-sm-6">
                <label for="totalPresent" class="form-label">एकूण उपस्थित</label>
                <input type="number" id="totalPresent" class="form-control" formControlName="totalPresent" readonly>
              </div>
              <div class="col-md-3 col-sm-6">
                <label for="attendancePercentagePresent" class="form-label">उपस्थिती टक्केवारी (%)</label>
                <input type="number" id="attendancePercentagePresent" class="form-control" formControlName="attendancePercentagePresent" readonly>
              </div>
              <div class="col-md-3 col-6">
                <label for="boysAbsent" class="form-label">गैरहजर मुले</label>
                <input type="number" id="boysAbsent" class="form-control" formControlName="boysAbsent" readonly>
              </div>
              <div class="col-md-3 col-6">
                <label for="girlsAbsent" class="form-label">गैरहजर मुली</label>
                <input type="number" id="girlsAbsent" class="form-control" formControlName="girlsAbsent" readonly>
              </div>
              <div class="col-md-3 col-sm-6">
                <label for="totalAbsent" class="form-label">एकूण गैरहजर</label>
                <input type="number" id="totalAbsent" class="form-control" formControlName="totalAbsent" readonly>
              </div>
              <div class="col-md-3 col-sm-6">
                <label for="attendancePercentageAbsent" class="form-label">गैरहजेरी टक्केवारी (%)</label>
                <input type="number" id="attendancePercentageAbsent" class="form-control" formControlName="attendancePercentageAbsent" readonly>
              </div>
            </div>

            <!-- Facilities Section -->
            <h5 class="form-section-title mb-3">क. शाळेतील सुविधा (School Facilities)</h5>
            <div class="row g-2 mb-4" formArrayName="facilities">
              <div *ngFor="let facility of availableFacilities; let i = index" class="col-lg-3 col-md-4 col-sm-6">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" [formControlName]="i" [id]="'facility_' + i">
                  <label class="form-check-label" [for]="'facility_' + i">
                    {{ facility }}
                  </label>
                </div>
              </div>
              <div *ngIf="f['facilities'].invalid && (f['facilities'].dirty || f['facilities'].touched)" class="text-danger small mt-1 col-12">
                <!-- Add specific error messages if needed -->
              </div>
            </div>

            <!-- Feedback Section -->
            <h5 class="form-section-title mb-3">ड. शैक्षणिक अभिप्राय (Educational Feedback)</h5>
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <label for="readingFeedback" class="form-label">वाचन अभिप्राय</label>
                <textarea id="readingFeedback" rows="3" class="form-control" formControlName="readingFeedback"></textarea>
              </div>
              <div class="col-md-4">
                <label for="writingFeedback" class="form-label">लेखन अभिप्राय</label>
                <textarea id="writingFeedback" rows="3" class="form-control" formControlName="writingFeedback"></textarea>
              </div>
              <div class="col-md-4">
                <label for="mathFeedback" class="form-label">गणित अभिप्राय</label>
                <textarea id="mathFeedback" rows="3" class="form-control" formControlName="mathFeedback"></textarea>
              </div>
            </div>

            <!-- General Remark -->
            <div class="mb-4">
              <label for="remark" class="form-label">इ. शेरा / इतर निरीक्षणे (Remark / Other Observations)</label>
              <textarea id="remark" rows="4" class="form-control" formControlName="remark"></textarea>
            </div>

            <!-- Image Sections -->
            <h5 class="form-section-title mb-3">फ. फोटो आणि जिओटॅगिंग (Photos & Geotagging)</h5>
            <div formArrayName="imageSections">
              <div *ngFor="let imgCtrl of imageSections.controls; let i = index" [formGroupName]="i"
                class="image-section-item card mb-3">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="card-subtitle text-muted mb-0">फोटो {{ i + 1 }}</h6>
                    <button *ngIf="imageSections.length > 1 || (imageSections.length === 1 && i > 0) " type="button"
                      class="btn btn-sm btn-outline-danger p-1 lh-1" (click)="removeImageSection(i)" title="हा फोटो काढा">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                      </svg>
                    </button>
                  </div>
                  <div class="row g-3 align-items-center">
                    <div class="col-md-5">
                      <!-- Image Preview Area -->
                      <div class="image-preview-container text-center border rounded p-3 mb-2"
                           style="min-height: 150px; display: flex; align-items: center; justify-content: center; flex-direction: column; background-color: #f8f9fa;">
                        <div *ngIf="getPreviewUrl(i); else noPreviewContent" class="w-100">
                          <img [src]="getPreviewUrl(i)" alt="फोटो प्रीव्ह्यू"
                               class="img-thumbnail mb-2" style="max-width: 100%; max-height: 110px; object-fit: contain;">
                        </div>
                        <ng-template #noPreviewContent>
                          <span class="text-muted">फोटो नाही</span>
                          <small *ngIf="imageSections.at(i).get('existingImageFilename')?.value && !isLoading" class="text-muted d-block mt-1">
                             <!-- To show if there's an existing filename but no base64 preview yet (e.g. URL from server) -->
                             {{ imageSections.at(i).get('existingImageFilename')?.value | slice:0:15 }}...
                          </small>
                        </ng-template>
                      </div>


                      <!-- Action Buttons for Image -->
                      <div class="mt-2 text-center">
                        <button type="button" class="btn btn-sm btn-primary me-2" (click)="openCameraModal(i)" title="कॅमेरा उघडा">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-camera-fill me-1" viewBox="0 0 16 16">
                            <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0"/>
                            <path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1m9 2.5a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0"/>
                          </svg>
                          कॅमेरा
                        </button>
                        <label [for]="'imageUpload' + i" class="btn btn-sm btn-outline-secondary" title="फाइल मधून निवडा">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-upload me-1" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                            <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708z"/>
                          </svg>
                          अपलोड
                        </label>
                        <input type="file" [id]="'imageUpload' + i" class="visually-hidden"
                               accept="image/*" (change)="onFileChange($event, i)">
                      </div>
                    </div>
                    <div class="col-md-3 col-6">
                      <label [for]="'latitude' + i" class="form-label">अक्षांश</label>
                      <input type="number" [id]="'latitude' + i" class="form-control form-control-sm" formControlName="latitude" step="any" placeholder="उदा. 18.5204">
                    </div>
                    <div class="col-md-3 col-6">
                      <label [for]="'longitude' + i" class="form-label">रेखांश</label>
                      <input type="number" [id]="'longitude' + i" class="form-control form-control-sm" formControlName="longitude" step="any" placeholder="उदा. 73.8567">
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-outline-success btn-sm mt-2 mb-3" (click)="addImageSection()"
              [disabled]="imageSections.length >= 4">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-circle me-1" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
              </svg>
              आणखी फोटो जोडा (कमाल ४)
            </button>

            <!-- Action Buttons -->
            <div class="button-container mt-4 pt-3 border-top">
              <button type="submit" class="btn btn-primary" [disabled]="visitForm.invalid || isLoading">
                <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                {{ isEditing ? 'माहिती अपडेट करा' : 'माहिती सबमिट करा' }}
              </button>
              <button type="button" (click)="onReset()" class="btn btn-outline-secondary" [disabled]="isLoading">रीसेट करा</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Camera Modal -->
  <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cameraModalLabel">फोटो घ्या</h5>
          <button type="button" class="btn-close" aria-label="Close" (click)="closeCameraModal()"></button>
        </div>
        <div class="modal-body text-center p-0"> <!-- p-0 to allow video wrapper to fill body -->
            <div style="position: relative; min-height: 200px; background-color: #333;"> <!-- Wrapper for positioning and background -->
                <video #videoPlayer id="videoPlayer" autoplay playsinline
                       style="width: 100%; max-height: 400px; display: block; object-fit: contain;">
                       <!-- object-fit: contain helps if aspect ratio of stream and video element differ -->
                </video>
                <!-- Loading/Error Overlay -->
                <div *ngIf="!isCameraStreamActive() || cameraError"
                     style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; background-color: rgba(51,51,51,0.85); color: white; flex-direction: column; padding: 1rem;">
                    <div *ngIf="cameraError" class="alert alert-danger m-0 p-2" style="max-width: 90%;">{{ cameraError }}</div>
                    <div *ngIf="!cameraError && !isCameraStreamActive()" class="p-3 text-center">
                        <div class="spinner-border text-light mb-2" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-2">कॅमेरा सुरू होत आहे...</div>
                    </div>
                </div>
            </div>
            <canvas #canvasElement id="canvasElement" style="display: none;"></canvas>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-primary px-4" (click)="capturePhoto()" [disabled]="!isCameraStreamActive() || !!cameraError">
             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-camera-reels-fill me-1" viewBox="0 0 16 16">
                <path d="M6 3a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                <path d="M9 6a3 3 0 1 1 0-6 3 3 0 0 1 0 6"/>
                <path d="M9 6h.5a2 2 0 0 1 2 2v7.5a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 0 15.5V8a2 2 0 0 1 2-2H3V4.5A1.5 1.5 0 0 1 4.5 3h1V1.5A1.5 1.5 0 0 1 7 0h2a1.5 1.5 0 0 1 1.5 1.5ZM5 6.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5Z"/>
                <path d="M16 11.5a1.5 1.5 0 0 1-1.5 1.5h-2A1.5 1.5 0 0 1 11 11.5V8a2 2 0 0 1 2-2h1.5a.5.5 0 0 1 0 1H13a1 1 0 0 0-1 1v3.5a.5.5 0 0 0 .5.5h2a.5.5 0 0 0 .5-.5V8.5a.5.5 0 0 1 1 0Z"/>
              </svg>
            फोटो काढा
          </button>
           <button type="button" class="btn btn-outline-secondary" (click)="closeCameraModal()">रद्द करा</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Table (Report Section) -->
  <div class="container report-section mt-5" *ngIf="submittedData.length > 0">
    <h4 class="mb-4 report-title text-center">नोंदवलेले शाळा भेट अहवाल</h4>
    <div class="table-responsive">
      <table class="table table-bordered table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th class="text-center">क्र.</th>
            <th>शाळेचे नाव</th>
            <th>भेट वर्ग</th>
            <th>इयत्ता</th>
            <th class="text-center">उपस्थिती (%)</th>
            <th>शेरा</th>
            <th class="text-center">फोटो १</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of submittedData; let i = index">
            <td class="text-center">{{ i + 1 }}</td>
            <td>{{ item.schoolName }}</td>
            <td>{{ item.visitedClass }}</td>
            <td>{{ item.grade }}<span *ngIf="item.section"> - {{ item.section }}</span></td>
            <td class="text-center">{{ item.attendancePercentagePresent !== null ? (item.attendancePercentagePresent | number:'1.0-2') + '%' : 'N/A' }}</td>
            <td class="remark-cell" title="{{ item.remark }}">{{ item.remark | slice:0:40 }}{{ item.remark && item.remark.length > 40 ? '...' : ''}}</td>
            <td class="text-center">
                <img *ngIf="item.imageSections[0]?.capturedImageData as imgData" [src]="imgData" alt="फोटो १" style="max-width: 50px; max-height: 50px; object-fit: cover; border:1px solid #eee; padding: 2px;">
                <span *ngIf="!item.imageSections[0]?.capturedImageData && item.imageSections[0]?.existingImageFilename" class="text-muted small">
                  {{ item.imageSections[0].existingImageFilename | slice:0:10 }}...
                </span>
                <span *ngIf="!item.imageSections[0]?.capturedImageData && !item.imageSections[0]?.existingImageFilename && !isLoading">N/A</span>
                <span *ngIf="isLoading && !item.imageSections[0]?.capturedImageData && !item.imageSections[0]?.existingImageFilename" class="spinner-border spinner-border-sm text-secondary" role="status"></span>
            </td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-warning me-1 py-0 px-1" (click)="editData(item, i)" title="Edit" [disabled]="isLoading">✏️</button>
              <button class="btn btn-sm btn-outline-danger py-0 px-1" (click)="deleteData(item, i)" title="Delete" [disabled]="isLoading">🗑️</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>